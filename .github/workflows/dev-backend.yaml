name: DEBUG SSH and ECR Login 

on:
  workflow_dispatch:

jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
    - name: Debug SSH and Login
      env:
        EC2_HOST: ${{ vars.EC2_BACKEND_HOST }}
        EC2_USER: ${{ vars.EC2_USER || 'ubuntu' }}
        SSH_KEY_BASE64: ${{ secrets.EC2_SSH_KEY_BASE64 }}
        AWS_REGION: ${{ vars.AWS_REGION }}
        ECR_REGISTRY: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
      run: |
        echo "$SSH_KEY_BASE64" | base64 --decode > ec2_key.pem
        chmod 600 ec2_key.pem

        ssh -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "bash -s" <<'EOF'
          set -e
          echo "Connected as: $(whoami)"
          echo "Testing Docker..."
          docker ps
          echo "Testing AWS CLI & ECR Login..."
          aws ecr get-login-password --region ${{ vars.AWS_REGION }} | docker login --username AWS --password-stdin ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
          echo "Login successful!"
        EOF